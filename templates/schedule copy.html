{% extends "base.html" %}
{% block content %}
{% csrf_token %}

<!-- <div class="container text-center">
    <h2>Select a Game to Attend</h2>
    <div class="row mt-4">
        {% for date in schedule %}
        <div class="col-md-4 mb-3">
            <div class="card {% if date in paid_weeks %}bg-success text-white{% else %}bg-light{% endif %}">
                <div class="card-body">
                    <h5>{{ date|date:"l, M j" }}</h5>
                    {% if date in paid_weeks %}
                        <p class="text-success">Already Paid</p>
                    {% else %}
                        <a href="{% url 'create_checkout_session' date_str=date %}" class="btn btn-primary">Pay $5</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div> -->

<div class="container mt-5">
    <h1 class="text-center">Register for Pickup Games</h1>
    <p class="text-center text-muted">
        Select multiple Mondays or pay for all at once.<br/>
        Already-paid dates appear in green and cannot be selected again.
    </p>    
    <!-- Container for the date checkboxes -->
    <div id="gameList" class="row row-cols-1 row-cols-md-2 g-4"></div>
    
    <!-- Section to display selected dates -->
    <div class="mt-4">
        <h5>Selected Dates:</h5>
        <ul id="selectedDatesList" class="list-unstyled"></ul>
    </div>
    
    <!-- Buttons for payment -->
    <div class="d-flex flex-column flex-md-row gap-2 mt-3">
        <!-- Button for paying for only the selected dates -->
        <button class="btn btn-primary flex-fill" onclick="handleSelectedCheckout()">
            Pay For Selected Dates
        </button>
        <!-- Button for paying $70 lumpsum for all dates -->
        <button class="btn btn-danger flex-fill" onclick="handleLumpSumCheckout()">
            Pay $70 For All
        </button>
    </div>
</div>

<!-- Include Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
//     function getCookie(name) {
//     let cookieValue = null;
//     if (document.cookie && document.cookie !== "") {
//         const cookies = document.cookie.split(";");
//         for (let i = 0; i < cookies.length; i++) {
//             const cookie = cookies[i].trim();
//             if (cookie.substring(0, name.length + 1) === (name + "=")) {
//                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
//                 break;
//             }
//         }
//     }
//     return cookieValue;
// }
//     const csrftoken = getCookie("csrftoken");
    const csrftoken = "{{ csrf_token }}";
    // const stripe = Stripe("pk_live_51Qe6VrKKPDelkA7OgycGGoqfOS3cfz4k6KQ53R2LvHJann8fxkRLFX2XF7CwBxqLOc8WfXpv3lLurLmh0og9TUlX00VSXk1ZM7");
    const stripe = Stripe("pk_test_51Qe6VrKKPDelkA7OOVE8XKi1D7SS3dprsHi201IIHQJFaJzUHqUgWjjaVGQUcprHjkb4DHHYpnSADtTtVrctr4rW00uBtvrMnm");

    const paidWeeks = JSON.parse('{{ paid_weeks_list|default:"[]"|safe }}');

    // Convert each date object in paidWeeks to a Set for quick membership checks
    const paidSet = new Set(paidWeeks);
    console.log(paidSet)

    // Holds the userâ€™s newly selected dates for purchase
    const selectedDates = new Set();

    // Generate all Monday dates through November
    function generateUpcomingMondays(count = 10) {
        const dates = [];
        let current = new Date();
        console.log("Starting card generation...");

        
        // Start from tomorrow to avoid including "today" if it's Monday
        current.setDate(current.getDate() + 1);

        while (dates.length < count) {
            if (current.getDay() === 1) {
                const display = current.toLocaleDateString("en-US", {
                    weekday: "long",
                    month: "long",
                    day: "numeric",
                    year: "numeric",
                });
                const yyyyMmDd = current.toISOString().split("T")[0];
                dates.push({ date: yyyyMmDd, display });
            }
            current.setDate(current.getDate() + 1);
        }

        return dates;
    }


    // Insert the cards into the DOM
    const gameDates = generateUpcomingMondays();
    console.log(gameDates)
    const gameList = document.getElementById("gameList");

    gameDates.forEach(({ date, display }) => {
        // Check if user already paid for this date
        const isPaid = paidSet.has(date);

        // Build each card
        const cardCol = document.createElement("div");
        cardCol.classList.add("col");

        // We'll store the date in a data attribute
        cardCol.innerHTML = `
        <div 
            class="card shadow p-3 h-100 game-card ${isPaid ? 'paid-card' : 'not-selected-card'}"
            id="card-${date}"
            data-date="${date}"
            data-isPaid="${isPaid}"
            onclick="toggleCard('${date}')"
        >
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h5 class="card-title">Monday</h5>
                    <p class="card-text">Blue Sport Stable</p>
                    <p class="card-text">1 Superior Dr, Superior, CO 80027</p>
                    <p class="card-text">5:30 pm - 8:00 pm</p>
                </div>
                <div class="mt-2 text-center">
                    <strong>${display}</strong>
                    ${
                        isPaid 
                        ? '<p class="text-success my-2">Already Paid</p>'
                        : ''
                    }
                </div>
            </div>
        </div>
        `;
        gameList.appendChild(cardCol);
    });

    // When user clicks a card, toggle selection if not paid
    function toggleCard(dateVal) {
        const cardEl = document.getElementById(`card-${dateVal}`);
        const isPaid = (cardEl.dataset.ispaid === 'true'); // string => bool

        if (isPaid) {
            // If it's already paid, do nothing or optionally show a message
            alert("You have already paid for this date.");
            return;
        }

        // If user hasn't paid, we toggle the highlight for selection
        if (selectedDates.has(dateVal)) {
            selectedDates.delete(dateVal);
            // revert card styling
            cardEl.classList.remove('selected-card');
            cardEl.classList.add('not-selected-card');
        } else {
            selectedDates.add(dateVal);
            cardEl.classList.remove('not-selected-card');
            cardEl.classList.add('selected-card');
        }

        refreshSelectedList();
    }

    // Update the displayed list of newly selected (unpaid) dates
    function refreshSelectedList() {
        const listEl = document.getElementById("selectedDatesList");
        listEl.innerHTML = "";

        if (selectedDates.size === 0) {
            listEl.innerHTML = "<li class='text-muted'>No dates selected.</li>";
        } else {
            selectedDates.forEach(d => {
                const li = document.createElement("li");
                li.textContent = d;
                listEl.appendChild(li);
            });
        }
    }

    // Pay for selected dates
    async function handleSelectedCheckout() {
        if (selectedDates.size === 0) {
            alert("Please select at least one date that is not paid.");
            return;
        }
        
        const selectedArray = Array.from(selectedDates);
        const response = await fetch("/api/create-multi-checkout-session", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({
                lumpsum: false,
                dates: selectedArray
            })
        });
        const session = await response.json();
        
        if (!session.id) {
            alert("Error creating checkout session.");
            return;
        }
        
        await stripe.redirectToCheckout({ sessionId: session.id });
    }

    // Pay lumpsum $70 for all Mondays
    async function handleLumpSumCheckout() {
        const response = await fetch("/api/create-multi-checkout-session", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({
                lumpsum: true
            })
        });
        const session = await response.json();

        if (!session.id) {
            alert("Error creating lumpsum checkout session.");
            return;
        }

        await stripe.redirectToCheckout({ sessionId: session.id });
    }

    // Initialize with empty list
    refreshSelectedList();
    </script>

    <!-- Some quick custom styles -->
    <style>
    .paid-card {
        background-color: #d4edda; /* Light green for paid */
        border: 2px solid #155724; /* Darker green border */
        color: #155724;
        cursor: not-allowed; /* so user can't select it again */
    }

    .selected-card {
        background-color: #cce5ff; /* Light blue highlight */
        border: 2px solid #004085;
        color: #004085;
    }

    .not-selected-card {
        background-color: #ffffff; /* default white */
        border: 1px solid #ccc;
        color: #333;
        cursor: pointer;
    }

    .game-card:hover {
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    </style>
{% endblock %}
