{% extends "base.html" %}
{% block title %}Waldschänke Brunch Ball{% endblock %}

{% load static %}

{% block hero_background %}{% static 'images/banner_schedule.jpeg' %}{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container mt-5">
    <h1 class="text-center text-uppercase">Reserve Your Spot Below for Waldschänke Brunch Ball 12/7</h1>
    <p class="text-center text-muted text-uppercase">
        A ONE TIME EVENT AT WÄLDSCHANKE CIDERS<br/>
        UNLIMITED PICKUP GAMES, PLAYER PRIZE PACKAGE & RAFFLE ENTRY
    </p>

    <!-- Event Card -->
    <div class="row row-cols-1 row-cols-md-2 g-4 justify-content-center">
        <div class="col-md-6">
            <div class="card shadow p-3 h-100 game-card {% if has_registered %}paid-card{% elif player_cap_reached %}spectator-card{% else %}not-selected-card{% endif %}"
                 id="event-card"
                 onclick="{% if not has_registered %}{% if player_cap_reached %}registerAsSpectator(){% else %}registerForEvent(){% endif %}{% endif %}">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title text-center"><strong>Sunday, December 7, 2025</strong></h5>
                        <p class="card-text text-center">Wäldschanke Ciders</p>
                        <p class="card-text text-center">4100 Jason St, Denver</p>
                        <p class="card-text text-center">10:30 AM - 1:30 PM</p>
                        
                        {% if player_cap_reached and not has_registered %}
                            <div class="text-center mb-3">
                                <p class="text-warning fw-bold mb-2">⚽ PLAYER SPOTS FULL ({{ paid_players_count }}/40)</p>
                                <p class="card-text text-center text-muted">FREE SPECTATOR REGISTRATION</p>
                            </div>
                        {% else %}
                            <p class="card-text text-center">$15 FOR EVENT</p>
                        {% endif %}
                    </div>
                    <div class="mt-2 text-center">
                        {% if has_registered %}
                            <p class="text-success text-uppercase fw-bold my-2">Already Registered</p>
                        {% elif player_cap_reached %}
                            <p class="text-primary fw-bold my-2">Click to Register as Spectator</p>
                            <small class="text-muted">Enjoy food, drinks & watch the games!</small>
                        {% else %}
                            <p class="text-primary fw-bold my-2">Click to Register & Play</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
const stripe = Stripe("pk_live_51Qe6VrKKPDelkA7OgycGGoqfOS3cfz4k6KQ53R2LvHJann8fxkRLFX2XF7CwBxqLOc8WfXpv3lLurLmh0og9TUlX00VSXk1ZM7");
const csrftoken = "{{ csrf_token }}";

async function registerForEvent() {
    try {
        const res = await fetch("/api/create-waldschanke-checkout-session", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            }
        });
        const session = await res.json();

        if (!session.id) throw new Error("No session ID returned.");
        
        await stripe.redirectToCheckout({ sessionId: session.id });
    } catch (err) {
        console.error(err);
        alert("Error creating checkout. Please try again.");
    }
}

async function registerAsSpectator() {
    try {
        const res = await fetch("/api/register-free-spectator", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            }
        });
        
        if (res.ok) {
            alert("Successfully registered as spectator!");
            location.reload();
        } else {
            const error = await res.json();
            alert(error.error || "Registration failed. Please try again.");
        }
    } catch (err) {
        console.error(err);
        alert("Error registering. Please try again.");
    }
}
</script>

<style>
.paid-card {
    background-color: #d4edda;
    border: 2px solid #155724;
    color: #155724;
    cursor: not-allowed;
}
.spectator-card {
    background-color: #fff3cd;
    border: 2px solid #856404;
    color: #856404;
    cursor: pointer;
}
.not-selected-card {
    background-color: #ffffff;
    border: 1px solid #ccc;
    color: #333;
    cursor: pointer;
}
.game-card:hover {
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
</style>
{% endblock %}
