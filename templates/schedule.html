{% extends "base.html" %}
{% block title %}Schdule Sport Stable{% endblock %}


{% load static %}

{% block hero_background %}{% static 'images/banner_schedule.jpeg' %}{% endblock %}

{% block content %}
{% csrf_token %}

<div class="container mt-5">
    <h1 class="text-center text-uppercase">Reserve Your spot for the Sport Stable Series</h1>
    <p class="text-center text-muted text-uppercase">
        Select one or multiple games.<br/>
        First Session is <strong>FREE</strong>! <br/>
    </p>

    <!-- Where the date cards go -->
    <div id="gameList" class="row row-cols-1 row-cols-md-2 g-4"></div>

    <!-- Where chosen (unpaid) dates show up -->
    <div class="mt-4">
        <h5>Selected Dates:</h5>
        <ul id="selectedDatesList" class="list-unstyled"></ul>
    </div>

      <!-- Bottom sliding checkout bar (hidden by default) -->
    <div id="checkoutBar" class="fixed-bottom bg-white shadow-lg p-3 d-none" style="z-index: 1030;">   
  <div class="container d-flex justify-content-between align-items-center">
    <span id="cartCount" class="fw-bold">0 games selected</span>

            <button 
  id="checkoutBtn" 
  class="btn btn-primary"
  onclick="handleSelectedCheckout()"
>
  <span id="checkoutLabel">Checkout</span>
  <span id="checkoutSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
</button>

  </div>
</div>


    <!-- Payment Buttons -->
    <!-- <div class="d-flex flex-column flex-md-row gap-2 mt-3">
        <button class="btn btn-primary flex-fill" onclick="handleSelectedCheckout()">
            Pay For Selected Dates
        </button>
         <button class="btn btn-danger flex-fill" onclick="handleLumpSumCheckout()">
            Pay $70 For All
        </button>
    </div> -->
</div>

<!-- 1) Load Stripe externally. -->
<script src="https://js.stripe.com/v3/"></script>


<!-- 2) Then your inline script. -->
<script>
 const stripe = Stripe("pk_live_51Qe6VrKKPDelkA7OgycGGoqfOS3cfz4k6KQ53R2LvHJann8fxkRLFX2XF7CwBxqLOc8WfXpv3lLurLmh0og9TUlX00VSXk1ZM7");
//  const stripe = Stripe("pk_test_51Qe6VrKKPDelkA7OOVE8XKi1D7SS3dprsHi201IIHQJFaJzUHqUgWjjaVGQUcprHjkb4DHHYpnSADtTtVrctr4rW00uBtvrMnm");
 const csrftoken = "{{ csrf_token }}"; 


  // Paid date strings from the server
  const paidWeeks = JSON.parse('{{ paid_weeks_list|default:"[]"|safe }}');
  // Make a Set for quick membership checks
  const paidSet = new Set(paidWeeks);

  // Store user’s newly selected dates for purchase
  const selectedDates = new Set();

  // Example: generate next 10 Mondays
//   function generateUpcomingMondays(count = 10) {
//       const dates = [];
//       let current = new Date();
//       // Start from tomorrow to avoid including "today" if it's Monday
//       current.setDate(current.getDate() + 1);

//       while (dates.length < count) {
//           if (current.getDay() === 1) {
//               const display = current.toLocaleDateString("en-US", {
//                   weekday: "long",
//                   month: "long",
//                   day: "numeric",
//                   year: "numeric",
//               });
//               const yyyyMmDd = current.toISOString().split("T")[0];
//               dates.push({ date: yyyyMmDd, display });
//           }
//           current.setDate(current.getDate() + 1);
//       }
//       return dates;
//   }

function generateMondaysFromApril21ToEndOfNov2025() {
    const startDate = new Date(2025, 3, 28);  // 3 => April (0-based index)
    const endDate = new Date(2025, 10, 30);   // 10 => November 30 (0-based index => 10=November)

    const dates = [];
    let current = new Date(startDate);

    // Loop until current > endDate
    while (current <= endDate) {
        // If it's a Monday (getDay() === 1)
        if (current.getDay() === 1) {
            const display = current.toLocaleDateString("en-US", {
                weekday: "long",
                month: "long",
                day: "numeric",
                year: "numeric",
            });
            const yyyyMmDd = current.toISOString().split("T")[0];
            dates.push({ date: yyyyMmDd, display });
        }
        // Move forward one day
        current.setDate(current.getDate() + 1);
    }

    return dates;
}


// 1) generate *all* the Mondays
const allGameDates = generateMondaysFromApril21ToEndOfNov2025();

// 2) build a "today" at midnight, so we treat all of today as not in the past
const today = new Date();
today.setHours(0, 0, 0, 0);

// 3) filter out any date < today
// const gameDates = allGameDates.filter(({ date }) => {
// // date strings are "YYYY‑MM‑DD", so new Date(date) is midnight of that date
// return new Date(date) >= today;
// });

// parse "YYYY-MM-DD" into a local-midnight Date
function parseLocalDate(isoDate) {
  const [year, month, day] = isoDate.split("-").map(Number);
  return new Date(year, month - 1, day);
}

const gameDates = allGameDates.filter(({ date }) => {
  const d = parseLocalDate(date);
  return d >= today;
});

// 4) now render only the upcoming (or today’s) games
const gameList = document.getElementById("gameList");
gameDates.forEach(({ date, display }, index) => {
    const isPaid      = paidSet.has(date);
    const isFirstGame = index === 0;
      const cardCol = document.createElement("div");
      cardCol.classList.add("col");

      cardCol.innerHTML = `
        <div 
          class="card shadow p-3 h-100 game-card ${isPaid ? 'paid-card' : 'not-selected-card'}"
          id="card-${date}"
          data-date="${date}"
          data-isPaid="${isPaid}"
          onclick="toggleCard('${date}')"
        >
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h5 class="card-title text-center"><strong>${display}</strong></h5>
                    <p class="card-text text-center">Blue Sport Stable</p>
                    <p class="card-text text-center">1 Superior Dr, Superior, CO 80027</p>
                    <p class="card-text text-center">6:00 pm - 8:00 pm</p>
                    <p class="card-text text-center">$5 Per Session</p>
                </div>
                <div class="mt-2 text-center">
                    ${
                      isPaid 
                        ? '<p class="text-success  text-uppercase fw-bold my-2">Already Paid</p>'
                        // : isFirstGame
                        // ? '<p class="text-alert my-2 fw-bold text-uppercase">First Game FREE</p>'
                        : ''
                    }
                </div>
            </div>
        </div>
      `;
      gameList.appendChild(cardCol);
  });

  function toggleCard(dateVal) {
      const cardEl = document.getElementById(`card-${dateVal}`);
      const isPaid = (cardEl.dataset.ispaid === 'true');
      const isFirstGame = (cardEl.dataset.isfirstgame === 'true');

      if (isPaid) {
          alert("You have already paid for this date.");
          return;
      }
      if (isFirstGame) {
        alert("This is a free introduction game! No payment required.");
        return;
    }
      if (selectedDates.has(dateVal)) {
          selectedDates.delete(dateVal);
          cardEl.classList.remove('selected-card');
          cardEl.classList.add('not-selected-card');
      } else {
          selectedDates.add(dateVal);
          cardEl.classList.remove('not-selected-card');
          cardEl.classList.add('selected-card');
      }
      refreshSelectedList();
  }

  function refreshSelectedList() {
      const listEl = document.getElementById("selectedDatesList");
      listEl.innerHTML = "";
      if (selectedDates.size === 0) {
          listEl.innerHTML = "<li class='text-muted'>No dates selected.</li>";
      } else {
          selectedDates.forEach(d => {
              const li = document.createElement("li");
              li.textContent = d;
              listEl.appendChild(li);
          });
      }
    updateCheckoutBar();
  }

  function updateCheckoutBar() {
  const bar       = document.getElementById("checkoutBar");
  const cartCount = document.getElementById("cartCount");

  if (selectedDates.size > 0) {
    cartCount.textContent = 
      `${selectedDates.size} game${selectedDates.size > 1 ? "s" : ""} selected`;
    bar.classList.remove("d-none");
  } else {
    bar.classList.add("d-none");
  }
}

// Initialize it on page load in case you ever pre‑populate selections:
updateCheckoutBar();

async function handleSelectedCheckout() {
  const btn   = document.getElementById('checkoutBtn');
  const label = document.getElementById('checkoutLabel');
  const spin  = document.getElementById('checkoutSpinner');

  // If nothing selected, bail
  if (selectedDates.size === 0) {
    alert("Please select at least one date.");
    return;
  }

  // Disable UI
  btn.disabled = true;
  label.textContent = 'Processing…';
  spin.classList.remove('d-none');

  try {
    const res = await fetch("/api/create-multi-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({
        lumpsum: false,
        dates: Array.from(selectedDates)
      })
    });
    const session = await res.json();

    if (session.free) {
      // instant success flow
      window.location.href = `/payment-success/?dates=${session.dates.join(',')}`;
      return;
    }
    if (!session.id) throw new Error("No session ID returned.");

    await stripe.redirectToCheckout({ sessionId: session.id });
  } catch (err) {
    // Something went wrong: re-enable so they can retry
    console.error(err);
    alert("Error creating checkout. Please try again.");
    btn.disabled = false;
    label.textContent = 'Checkout';
    spin.classList.add('d-none');
  }
}

  // async function handleSelectedCheckout() {
  //     const btn   = document.getElementById('checkoutBtn');
  //     const label = document.getElementById('checkoutLabel');
  //     const spin  = document.getElementById('checkoutSpinner');

  //     if (selectedDates.size === 0) {
  //         alert("Please select at least one date that is not paid.");
  //         return;
  //     }

  //     const selectedArray = Array.from(selectedDates);
  //     const response = await fetch("/api/create-multi-checkout-session", {
  //         method: "POST",
  //         headers: { 
  //             "Content-Type": "application/json",
  //             "X-CSRFToken": csrftoken
  //         },
  //         body: JSON.stringify({
  //             lumpsum: false,
  //             dates: selectedArray
  //         })
  //     });
  //     const session = await response.json();

  //     // 1) If server says “free,” go straight to success
  //     if (session.free) {
  //       // session.dates is the full list you passed
  //       window.location.href = `/payment-success/?dates=${session.dates.join(',')}`;
  //       return;
  //     }

  //     if (!session.id) {
  //         alert("Error creating checkout session.");
  //         return;
  //     }
  //     await stripe.redirectToCheckout({ sessionId: session.id });
  // }

//   async function handleLumpSumCheckout() {
//       const response = await fetch("/api/create-multi-checkout-session", {
//           method: "POST",
//           headers: { 
//               "Content-Type": "application/json",
//               "X-CSRFToken": csrftoken
//           },
//           body: JSON.stringify({ lumpsum: true })
//       });
//       const session = await response.json();
//       if (!session.id) {
//           alert("Error creating lumpsum checkout session.");
//           return;
//       }
//       await stripe.redirectToCheckout({ sessionId: session.id });
//   }

  // initialize
  refreshSelectedList();
</script>

<style>
  .paid-card {
      background-color: #d4edda; /* Light green for paid */
      border: 2px solid #155724; /* Darker green border */
      color: #155724;
      cursor: not-allowed;
  }
  .selected-card {
      background-color: #cce5ff; /* Light blue highlight */
      border: 2px solid #004085;
      color: #004085;
  }
  .not-selected-card {
      background-color: #ffffff;
      border: 1px solid #ccc;
      color: #333;
      cursor: pointer;
  }
  .game-card:hover {
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .free-game-card {
    background-color: #d4edda; /* Light yellow for free game */
    border: 2px solid #155724; /* Darker yellow border */
    color: #155724;
    cursor: not-allowed;
}
#checkoutBar {
  transition: transform 0.3s ease-in-out;
}
#checkoutBar.d-none {
  transform: translateY(100%);
}
#checkoutBar:not(.d-none) {
  transform: translateY(0);
}
</style>
{% endblock %}
